<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pre-screening Form</title>
    <link rel="icon" href="vam.png" type="image/png" />
    <style>
      body,
      html {
        margin: 0;
        padding: 10px;
        background: linear-gradient(120deg, #e6e6fa, #daf7a6);
        color: #000;
        height: fit-content;
        font-family: Arial, sans-serif;
      }

      .form-container {
        width: 96%;
        margin: 0 auto;
        border: 1px solid #333;
        padding: 20px;
        box-sizing: border-box;
        background-color: white;
      }

      .section {
        margin-bottom: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .candidate-container {
        display: flex;
        flex-direction: column;
        flex: 2;
        max-width: 60%;
      }

      .candidate-info {
        background-color: white;
        color: black;
        font-weight: bold;
      }

      .candidate-photo {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .image-container {
        width: 350px;
        height: 350px;
        border: 2px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background-color: #f8f8f8;
        cursor: pointer;
      }

      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        /* Fit the image inside the box while maintaining aspect ratio */
        display: block;
        object-position: center;
        /* Keep image centered */
      }

      .upload-label {
        cursor: pointer;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      table,
      .experience-table {
        border-radius: 5px;
      }

      th,
      td {
        border: 0.5px solid #888888;
        padding: 8px;
        text-align: left;
        width: 33.33%;
      }

      th {
        background-color: #bbbbbb;
        color: black;
      }

      .pre-screening {
        background-color: #bbbbbb;
        color: black;
      }

      .shortlisted {
        background-color: #90ee90;
      }

      .not-shortlisted {
        background-color: #ffb6c1;
      }

      .experience-table th {
        background-color: #bbbbbb;
        color: black;
      }

      table.experience-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      th,
      td {
        border: 0.5px solid #888888;
        padding: 8px;
        text-align: left;
        width: 25%;
      }

      .centered-text {
        text-align: center;
      }

      .feedback-section {
        margin-top: 25px;
      }

      .feedback-section-text {
        margin-top: 5px;
        height: 100px;
        width: 100%;
        font-family: Arial, sans-serif;
      }

      .feedback-section label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }

      .feedback-section textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        min-height: 250px;
        resize: vertical;
        border-radius: 4px;
        font-size: 1rem;
        border: 1px solid #888888;
      }

      .result-section {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .result-section label {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .result-select {
        padding: 8px;
        width: 100%;
        max-width: 200px;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3sease;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"] {
        width: 92%;
        padding: 0.75rem;
        border: 1px solid #b8b8b8;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3sease;
        font-family: Arial, sans-serif;
      }

      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #b8b8b8;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3sease;
        font-family: Arial, sans-serif;
        cursor: pointer;
      }

      .styled-dropdown {
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid #888888;
        background-color: #fff;
        width: 100%;
        appearance: none;
        background-repeat: no-repeat;
        background-position: right 10px center;
      }

      .styled-dropdown option {
        padding: 5px;
        font-size: 14px;
      }

      .styled-dropdown option:nth-child(odd) {
        background-color: #f4f4f4;
      }

      .styled-dropdown option:nth-child(even) {
        background-color: #ffffff;
      }

      .styled-dropdown:focus {
        border-color: #007bff;
        outline: none;
      }

      .green-background {
        background-color: green;
        color: white;
      }

      .red-background {
        background-color: red;
        color: white;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        display: none;
        z-index: 9999;
      }

      .toast.show {
        display: block;
      }

      .toast.success {
        background-color: #4caf50;
      }

      .toast.error {
        background-color: #f44336;
      }
    </style>
  </head>

  <body>
    <div class="form-container">
      <center>
        <h1><strong>TAG Team Prescreening Form</strong></h1>
      </center>
      <div style="color: #000000; width: 60%">
        <select id="candidate-email-dropdown" class="styled-dropdown">
          <option value="">Select a Candidate Email</option>
        </select>
      </div>
      <br />

      <div class="header">
        <div class="candidate-container">
          <div class="candidate-info">
            <table>
              <tr>
                <td class="details">RRF ID</td>
                <td>
                  <input type="text" id="rrf-id" placeholder="" readonly />
                </td>
              </tr>
              <tr>
                <td class="details">Job Designation</td>
                <td>
                  <input type="text" id="position" placeholder="" readonly />
                </td>
              </tr>
              <tr>
                <td class="details">Name of the Candidate</td>
                <td>
                  <input
                    type="text"
                    id="candidate-name"
                    placeholder=""
                    readonly
                  />
                </td>
              </tr>
              <tr>
                <td>UAN Number</td>
                <td>
                  <input
                    type="text"
                    id="uan-number"
                    placeholder="Enter UAN Number"
                    minlength="0"
                    maxlength="12"
                    oninput="this.value=this.value.replace(/[^0-9]/g, '')"
                  />
                </td>
              </tr>
              <tr>
                <td>Date of Interview</td>
                <td>
                  <input
                    type="date"
                    id="interview-date"
                    onclick="this.showPicker()"
                  />
                </td>
              </tr>
              <tr>
                <td class="details">TAG Team Member</td>
                <td>
                  <input type="text" id="hr-email" placeholder="" readonly />
                </td>
              </tr>
            </table>
          </div>

          <div class="introduction-tables">
            <table>
              <tr>
                <td>Introduction of ValueMomentum</td>
                <td>
                  <select id="introduction-value-momentum">
                    <option value="" selected>Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Introduction of Cloud/App Engineering</td>
                <td>
                  <select id="introduction-cloud-app">
                    <option value="" selected>Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Introduction to Roles & Responsibilities</td>
                <td>
                  <select id="roles-responsibilities">
                    <option value="" selected>Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td>Did Candidate qualify using pre-screening Q's</td>
                <td>
                  <select id="pre-screening">
                    <option value="" selected>Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <div class="candidate-photo">
          <input
            type="file"
            id="imageUpload"
            accept="image/*"
            style="display: none"
          />
          <div class="image-container" id="imageContainer">
            <label for="imageUpload" id="uploadLabel" class="upload-label">
              <center>Upload</center>
              <br />Candidate Image
            </label>
            <img id="imagePreview" style="display: none" />
          </div>
        </div>
      </div>

      <div
        style="display: flex; align-items: center; justify-content: flex-start"
      >
        <table>
          <tr>
            <th class="pre-screening">Pre-screening Q's</th>
            <th>Summary</th>
          </tr>
          <tr>
            <td>
              <select id="status-dropdown" style="font-weight: bold">
                <option value="shortlisted">Shortlisted</option>
                <option value="not-shortlisted">Not Shortlisted</option>
              </select>
            </td>
            <td>
              <textarea
                id="summary"
                style="
                  height: 100px;
                  width: 100%;
                  font-family: Arial, sans-serif;
                "
              ></textarea>
            </td>
          </tr>
        </table>

        <!-- Dropdown on the right side -->
        <div style="margin-left: 50px">
          <label for="ec-select">Select the EC</label>
          <select id="ec-select" style="width: 150px">
            <option value="" selected>Select an option</option>
            <option value="Cloud">Cloud EC</option>
            <option value="App">App EC</option>
            <option value="Data">Data EC</option>
          </select>
        </div>
      </div>

      <div id="cloud-section" style="display: none">
        <div id="devops-section" class="section">
          <table>
            <thead>
              <tr>
                <th>DevOps Experience</th>
                <th>Number of years or Months</th>
                <th>Projects Handled</th>
              </tr>
            </thead>
            <tbody id="devops-table-body"></tbody>
          </table>
        </div>

        <div id="cloudops-section" class="section">
          <table>
            <thead>
              <tr>
                <th>CloudOps Experience</th>
                <th>Number of years or Months</th>
                <th>Projects Handled</th>
              </tr>
            </thead>
            <tbody id="cloudops-table-body"></tbody>
          </table>
        </div>

        <div id="platform-section" class="section">
          <table>
            <thead>
              <tr>
                <th>Platform Experience</th>
                <th>Number of years or Months</th>
                <th>Projects Handled</th>
              </tr>
            </thead>
            <tbody id="platform-table-body"></tbody>
          </table>
        </div>

        <div id="sre-section" class="section">
          <table>
            <thead>
              <tr>
                <th>Site Reliability Engineering (SRE) Experience</th>
                <th>Number of years or Months</th>
                <th>Projects Handled</th>
              </tr>
            </thead>
            <tbody id="sre-table-body"></tbody>
          </table>
        </div>
      </div>

      <div id="app-section" style="display: block">
        <!-- Java Section -->
        <div id="java-section">
          <div class="section">
            <table>
              <thead>
                <tr>
                  <th>Java Experience</th>
                  <th>Number of years or Months</th>
                  <th>Mandatory for Candidates</th>
                </tr>
              </thead>
              <tbody id="java-table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- .NET Section -->
        <div id="dotnet-section" style="display: block">
          <div class="section">
            <table>
              <thead>
                <tr>
                  <th>.NET Experience</th>
                  <th>Number of years or Months</th>
                  <th>Mandatory for Candidates</th>
                </tr>
              </thead>
              <tbody id="dotnet-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- React Section -->
      <div id="react-section" style="display: none">
        <div class="section">
          <table>
            <thead>
              <tr>
                <th>React Experience</th>
                <th>Number of years or Months</th>
                <th>Mandatory for Candidates</th>
              </tr>
            </thead>
            <tbody id="react-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Angular Section -->
      <div id="angular-section" style="display: none">
        <div class="section">
          <table>
            <thead>
              <tr>
                <th>Angular Experience</th>
                <th>Number of years or Months</th>
                <th>Mandatory for Candidates</th>
              </tr>
            </thead>
            <tbody id="angular-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Mendix Section -->
      <div id="mendix-section" style="display: none">
        <div class="section">
          <table>
            <thead>
              <tr>
                <th>Mendix Experience</th>
                <th>Number of years or Months</th>
                <th>Mandatory for Candidates</th>
              </tr>
            </thead>
            <tbody id="mendix-table-body"></tbody>
          </table>
        </div>
      </div>

      <div id="data-section" style="display: none">
        <div class="section">
          <table class="experience-table">
            <tr>
              <th>Data Engineering Experience</th>
              <th>Number of years or Months</th>
              <th>Projects Handled</th>
            </tr>
            <tr>
              <td>Total Experience in Data Engineering?</td>
              <td>
                <input
                  type="text"
                  id="data-engineering-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="data-engineering-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in SQL (PostgreSQL, MySQL, etc.)</td>
              <td>
                <input
                  type="text"
                  id="sql-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="sql-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in NoSQL (MongoDB, Cassandra, etc.)</td>
              <td>
                <input
                  type="text"
                  id="nosql-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="nosql-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in ETL Tools (Informatica, Talend, etc.)</td>
              <td>
                <input
                  type="text"
                  id="etl-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="etl-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in Big Data (Hadoop, Spark, Hive, etc.)</td>
              <td>
                <input
                  type="text"
                  id="bigdata-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="bigdata-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>
                Experience in Data Warehousing (Snowflake, Redshift, etc.)
              </td>
              <td>
                <input
                  type="text"
                  id="data-warehousing-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="data-warehousing-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in Data Pipelines (Airflow, Luigi, etc.)</td>
              <td>
                <input
                  type="text"
                  id="data-pipelines-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="data-pipelines-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
            <tr>
              <td>Experience in Data Analytics (Python, R, Pandas, etc.)</td>
              <td>
                <input
                  type="text"
                  id="data-analytics-experience"
                  placeholder="Enter total experience in Years/Months"
                />
              </td>
              <td>
                <input
                  type="text"
                  id="data-analytics-projects"
                  placeholder="Enter number of projects"
                />
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Feedback Section -->
      <div class="feedback-section">
        <label for="detailed-feedback">Detailed Feedback: *</label>
        <textarea
          id="detailed-feedback"
          class="feedback-section-text"
          placeholder="Enter your detailed feedback here..."
          required
        ></textarea>
      </div>

      <button type="button" id="generate-feedback-btn">
        Generate Feedback (AI)
      </button>

      <div style="display: flex; justify-content: center">
        <button
          id="submit-button"
          style="
            background-color: #1f4e79;
            color: #ffffff;
            height: 25px;
            width: 200px;
            border-radius: 5px;
          "
        >
          Submit
        </button>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <br />

    <script>
      function showToast(message, type) {
        const toast = document.getElementById("toast");
        toast.className = `toast ${type}`; // success, error
        toast.textContent = message;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const summaryBox = document.getElementById("status-dropdown");
        const selectedValue = summaryBox.value;
        summaryBox.classList.remove("green-background", "red-background");
        if (selectedValue === "shortlisted") {
          summaryBox.classList.add("green-background");
        } else if (selectedValue === "not-shortlisted") {
          summaryBox.classList.add("red-background");
        }

        // Retrieve candidate details from localStorage
        const candidateDetails = JSON.parse(
          localStorage.getItem("candidateDetails")
        );
        if (candidateDetails && candidateDetails.finalSummary) {
          document.getElementById("summary").value =
            candidateDetails.finalSummary;
        }
      });

      // Event listener for changing the selection
      document
        .getElementById("status-dropdown")
        .addEventListener("change", function () {
          const summaryBox = document.getElementById("status-dropdown");
          const selectedValue = this.value;
          summaryBox.classList.remove("green-background", "red-background");

          if (selectedValue === "shortlisted") {
            summaryBox.classList.add("green-background");
          } else if (selectedValue === "not-shortlisted") {
            summaryBox.classList.add("red-background");
          }
        });

      document
        .getElementById("imageContainer")
        .addEventListener("click", function () {
          document.getElementById("imageUpload").click();
        });

      // Handle image file selection and preview
      document
        .getElementById("imageUpload")
        .addEventListener("change", function (event) {
          var file = event.target.files[0];
          var image = document.getElementById("imagePreview");
          var label = document.querySelector('label[for="imageUpload"]'); // Get the label

          if (file && file.type.startsWith("image/")) {
            var reader = new FileReader();
            reader.onload = function (e) {
              image.src = e.target.result;
              image.style.display = "block"; // Show the image
              label.style.display = "none"; // Hide the label
              showToast("Image uploaded successfully!", "success");
            };
            reader.readAsDataURL(file);
          } else {
            image.src = "";
            image.style.display = "none";
            label.style.display = "block";
          }
        });

      document.addEventListener("DOMContentLoaded", function () {
        const candidateDetails = JSON.parse(
          localStorage.getItem("candidateDetails")
        );

        // Fetch all candidate emails from the server
        fetch("http://localhost:3000/api/getAllCandidateEmails")
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              showToast(data.error, "error");
            } else {
              const emailDropdown = document.getElementById(
                "candidate-email-dropdown"
              );
              data.emails.forEach((email) => {
                const option = document.createElement("option");
                option.value = email;
                option.textContent = email;
                emailDropdown.appendChild(option);
              });

              if (candidateDetails && candidateDetails.candidateEmail) {
                console.log(
                  "Candidate email found in localStorage:",
                  candidateDetails.candidateEmail
                );
                emailDropdown.value = candidateDetails.candidateEmail;

                fetchCandidateData(candidateDetails.candidateEmail);
                const finalSummary = localStorage.getItem("finalSummary");
                if (finalSummary) {
                  document.getElementById("summary").value = finalSummary;
                }
              }
            }
          })
          .catch((error) => {
            console.error("Error fetching candidate emails:", error);
            showToast("Failed to load candidate emails.", "error");
          });

        const emailDropdown = document.getElementById(
          "candidate-email-dropdown"
        );
        emailDropdown.addEventListener("change", function (event) {
          const selectedEmail = event.target.value;
          if (selectedEmail) {
            fetchCandidateData(selectedEmail);
            const finalSummary = localStorage.getItem("finalSummary");
            if (finalSummary) {
              document.getElementById("summary").value = finalSummary;
            }
          }
        });

        function fetchCandidateData(email) {
          fetch(
            `http://localhost:3000/api/getCandidateData?candidateEmail=${email}`
          )
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                showToast(data.error, "error");
              } else {
                document.getElementById("candidate-name").value =
                  data.candidate_name;
                document.getElementById("position").value = data.role;
                document.getElementById("rrf-id").value = data.rrf_id;
                document.getElementById("hr-email").value = data.hr_email;

                // --- App EC Roles ---
                const appRolesJava = [
                  "Junior Java Cloud Native Application Engineer - Backend",
                  "Senior Java Cloud Native Application Engineer - Backend",
                ];
                const appRolesDotNet = [
                  "Junior .Net Cloud Native Application Engineer - Backend",
                  "Senior .Net Cloud Native Application Engineer - Backend",
                ];
                const appRolesReact = [
                  "Junior React Cloud Native Application Engineer - Frontend",
                  "Senior React Cloud Native Application Engineer - Frontend",
                ];
                const appRolesAngular = [
                  "Junior Angular Cloud Native Application Engineer - Frontend",
                  "Senior Angular Cloud Native Application Engineer - Frontend",
                ];
                const appRolesMendix = [
                  "Junior Mendix LCNC Platform Engineer",
                  "Senior Mendix LCNC Platform Engineer",
                ];

                // --- Cloud EC Roles ---
                const devopsRoles = [
                  "Junior Azure DevOps Engineer",
                  "Senior Azure DevOps Engineer",
                  "Lead Azure DevOps Engineer",
                  "Junior AWS DevOps Engineer",
                  "Senior AWS DevOps Engineer",
                  "Lead AWS DevOps Engineer",
                ];
                const platformRoles = [
                  "Junior Azure Platform Engineer",
                  "Senior Azure Platform Engineer",
                  "Lead Azure Platform Engineer",
                  "Junior AWS Platform Engineer",
                  "Senior AWS Platform Engineer",
                  "Lead AWS Platform Engineer",
                ];
                const cloudopsRoles = [
                  "Junior Azure Cloudops Engineer",
                  "Senior Azure Cloudops Engineer",
                  "Lead Azure Cloudops Engineer",
                  "Junior AWS Cloudops Engineer",
                  "Senior AWS Cloudops Engineer",
                  "Lead AWS Cloudops Engineer",
                ];

                const isAppEC = [
                  ...appRolesJava,
                  ...appRolesDotNet,
                  ...appRolesReact,
                  ...appRolesAngular,
                  ...appRolesMendix,
                ].includes(data.role);

                const isCloudEC = [
                  ...devopsRoles,
                  ...platformRoles,
                  ...cloudopsRoles,
                ].includes(data.role);

                // --- Handle App EC Display ---
                if (isAppEC) {
                  document.getElementById("ec-select").value = "App";
                  document.getElementById("app-section").style.display =
                    "block";
                  document.getElementById("cloud-section").style.display =
                    "none";
                  document.getElementById("data-section").style.display =
                    "none";

                  // Hide all app sections
                  document.getElementById("java-section").style.display =
                    "none";
                  document.getElementById("dotnet-section").style.display =
                    "none";
                  document.getElementById("react-section").style.display =
                    "none";
                  document.getElementById("angular-section").style.display =
                    "none";
                  document.getElementById("mendix-section").style.display =
                    "none";

                  if (appRolesJava.includes(data.role)) {
                    document.getElementById("java-section").style.display =
                      "block";
                  } else if (appRolesDotNet.includes(data.role)) {
                    document.getElementById("dotnet-section").style.display =
                      "block";
                  } else if (appRolesReact.includes(data.role)) {
                    document.getElementById("react-section").style.display =
                      "block";
                  } else if (appRolesAngular.includes(data.role)) {
                    document.getElementById("angular-section").style.display =
                      "block";
                  } else if (appRolesMendix.includes(data.role)) {
                    document.getElementById("mendix-section").style.display =
                      "block";
                  }
                }

                // --- Handle Cloud EC Display ---
                if (isCloudEC) {
                  document.getElementById("ec-select").value = "Cloud";
                  document.getElementById("cloud-section").style.display =
                    "block";
                  document.getElementById("app-section").style.display = "none";
                  document.getElementById("data-section").style.display =
                    "none";

                  // Hide all cloud sections
                  document.getElementById("devops-section").style.display =
                    "none";
                  document.getElementById("cloudops-section").style.display =
                    "none";
                  document.getElementById("platform-section").style.display =
                    "none";
                  document.getElementById("sre-section").style.display = "none";

                  if (devopsRoles.includes(data.role)) {
                    document.getElementById("devops-section").style.display =
                      "block";
                  } else if (cloudopsRoles.includes(data.role)) {
                    document.getElementById("cloudops-section").style.display =
                      "block";
                  } else if (platformRoles.includes(data.role)) {
                    document.getElementById("platform-section").style.display =
                      "block";
                  }
                }
              }
            })
            .catch((error) => {
              console.error("Error fetching candidate data:", error);
              showToast("Failed to load candidate data.", "error");
            });
        }
      });

      document
        .getElementById("ec-select")
        .addEventListener("change", function () {
          const selectedValue = this.value;
          if (selectedValue === "Cloud") {
            document.getElementById("cloud-section").style.display = "block";
            document.getElementById("app-section").style.display = "none";
            document.getElementById("data-section").style.display = "none";
          } else if (selectedValue === "App") {
            document.getElementById("app-section").style.display = "block";
            document.getElementById("cloud-section").style.display = "none";
            document.getElementById("data-section").style.display = "none";
          } else if (selectedValue === "Data") {
            document.getElementById("data-section").style.display = "block";
            document.getElementById("cloud-section").style.display = "none";
            document.getElementById("app-section").style.display = "none";
          } else {
            // If no option is selected (the default one)
            document.getElementById("cloud-section").style.display = "none";
            document.getElementById("app-section").style.display = "none";
            document.getElementById("data-section").style.display = "none";
          }
        });

      document.getElementById("ec-select").dispatchEvent(new Event("change"));

      function validateWordCount(feedback) {
        const wordCount = feedback.trim().split(/\s+/).filter(Boolean).length;
        return wordCount >= 100;
      }

      document
        .getElementById("submit-button")
        .addEventListener("click", async () => {
          const candidateEmail = document.getElementById(
            "candidate-email-dropdown"
          ).value;
          const detailedFeedback =
            document.getElementById("detailed-feedback").value;
          const selectedRole = document.getElementById("position").value;
          const summaryBox = document.getElementById("status-dropdown").value;
          console.log("Selected status:", summaryBox);

          if (!candidateEmail || !selectedRole) {
            alert("Please select role and enter candidate email.");
            return;
          }

          let tableSelector = "";
          let apiEndpoint = "";

          // App EC roles
          if (selectedRole.toLowerCase().includes("java")) {
            tableSelector = "#java-table-body tr";
            apiEndpoint = "/api/java_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes(".net")) {
            tableSelector = "#dotnet-table-body tr";
            apiEndpoint = "/api/dotnet_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes("react")) {
            tableSelector = "#react-table-body tr";
            apiEndpoint = "/api/react_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes("angular")) {
            tableSelector = "#angular-table-body tr";
            apiEndpoint = "/api/angular_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes("mendix")) {
            tableSelector = "#mendix-table-body tr";
            apiEndpoint = "/api/mendix_ec_submit-feedback";

            // Cloud EC roles
          } else if (selectedRole.toLowerCase().includes("devops")) {
            tableSelector = "#devops-table-body tr";
            apiEndpoint = "/api/devops_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes("cloudops")) {
            tableSelector = "#cloudops-table-body tr";
            apiEndpoint = "/api/cloudops_ec_submit-feedback";
          } else if (selectedRole.toLowerCase().includes("platform")) {
            tableSelector = "#platform-table-body tr";
            apiEndpoint = "/api/platform_ec_submit-feedback";
          } else {
            alert("Selected role not supported.");
            return;
          }

          const rows = document.querySelectorAll(tableSelector);
          const number_of_years_or_months = [];

          rows.forEach((row) => {
            const skill = row.children[0].innerText;
            const input = row.children[1].querySelector("input");
            const experience = input ? input.value : "";
            number_of_years_or_months.push({ skill, experience });
          });

          const payload = {
            candidateEmail,
            number_of_years_or_months,
            detailed_feedback: detailedFeedback,
            status: summaryBox,
          };

          try {
            const response = await fetch(apiEndpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            if (response.ok) {
              showToast("✅ Feedback submitted successfully!");
              window.location.href = "l1-imocha.html";
            } else {
              showToast(`❌ Error: ${result.error || "Something went wrong."}`);
            }
          } catch (err) {
            console.error("Submit error:", err);
            showToast("❌ Failed to submit feedback. See console for details.");
          }
        });

      document.addEventListener("DOMContentLoaded", () => {
        // App EC roles
        loadQuestions(
          "/api/java_ec_questions",
          "java-table-body",
          "java_experience_"
        );
        loadQuestions(
          "/api/dotnet_ec_questions",
          "dotnet-table-body",
          "dotnet_experience_"
        );
        loadQuestions(
          "/api/react_ec_questions",
          "react-table-body",
          "react_experience_"
        );
        loadQuestions(
          "/api/angular_ec_questions",
          "angular-table-body",
          "angular_experience_"
        );
        loadQuestions(
          "/api/mendix_ec_questions",
          "mendix-table-body",
          "mendix_experience_"
        );

        // Cloud EC roles
        loadQuestions(
          "/api/devops_ec_questions",
          "devops-table-body",
          "devops_experience_"
        );
        loadQuestions(
          "/api/cloudops_ec_questions",
          "cloudops-table-body",
          "cloudops_experience_"
        );
        loadQuestions(
          "/api/platform_ec_questions",
          "platform-table-body",
          "platform_experience_"
        );
        loadQuestions(
          "/api/sre_ec_questions",
          "sre-table-body",
          "sre_experience_"
        );
      });

      async function loadQuestions(apiUrl, tbodyId, prefixToRemove = "") {
        try {
          const res = await fetch(apiUrl);
          const data = await res.json();
          const tbody = document.getElementById(tbodyId);
          tbody.innerHTML = "";

          data.forEach((q) => {
            const label = formatLabel(q.question_text, prefixToRemove);
            const inputId = q.question_text;

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${label}</td>
            <td><input type="text" id="${inputId}" placeholder="Enter total experience in Years/Months" /></td>
            <td>${q.mandatory_for_candidates}</td>
          `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error("Error loading questions:", error);
        }
      }

      function formatLabel(text, prefix) {
        return text
          .replace(prefix, "")
          .replace(/_/g, " ")
          .replace(/\b\w/g, (char) => char.toUpperCase());
      }

      async function generateFeedbackWithGemini(
        candidateEmail,
        selectedRole,
        skills
      ) {
        try {
          const geminiPrompt = `
      Please generate a detailed prescreening evaluation feedback for the following candidate:
      - Email: ${candidateEmail}
      - Role: ${selectedRole}
      - Skills & experience: ${skills
        .map((s) => `${s.skill}: ${s.experience}`)
        .join(", ")}
      Feedback should be professional, actionable, and at least 100 words.
    `;

          const geminiResponse = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyD1NqvfelSR6l-8FEIIFiZM3aJmbo2mw-Q",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: geminiPrompt }] }],
              }),
            }
          );

          const geminiData = await geminiResponse.json();
          const generatedText =
            geminiData.candidates?.[0]?.content?.parts?.[0]?.text || "";

          return generatedText.trim();
        } catch (error) {
          console.error("Error generating feedback with Gemini:", error);
          return "";
        }
      }

      document
        .getElementById("generate-feedback-btn")
        .addEventListener("click", async () => {
          const candidateEmail = document.getElementById(
            "candidate-email-dropdown"
          ).value;
          const selectedRole = document.getElementById("position").value;

          let tableSelector = "";
          if (selectedRole.toLowerCase().includes("java")) {
  tableSelector = "#java-table-body tr";
} else if (selectedRole.toLowerCase().includes(".net")) {
  tableSelector = "#dotnet-table-body tr";
} else if (selectedRole.toLowerCase().includes("react")) {
  tableSelector = "#react-table-body tr";
} else if (selectedRole.toLowerCase().includes("angular")) {
  tableSelector = "#angular-table-body tr";
} else if (selectedRole.toLowerCase().includes("mendix")) {
  tableSelector = "#mendix-table-body tr";
} else if (selectedRole.toLowerCase().includes("devops")) {
  tableSelector = "#devops-table-body tr";
} else if (selectedRole.toLowerCase().includes("cloudops")) {
  tableSelector = "#cloudops-table-body tr";
} else if (selectedRole.toLowerCase().includes("platform")) {
  tableSelector = "#platform-table-body tr";
} else if (selectedRole.toLowerCase().includes("sre")) {
  tableSelector = "#sre-table-body tr";
} else {
  alert("Selected role not supported for feedback generation.");
  return;
}


          const rows = document.querySelectorAll(tableSelector);
          const skills = [];
          rows.forEach((row) => {
            const skill = row.children[0].innerText;
            const input = row.children[1].querySelector("input");
            const experience = input ? input.value : "";
            skills.push({ skill, experience });
          });

          showToast("Generating feedback... please wait.", "success");

          const generatedFeedback = await generateFeedbackWithGemini(
            candidateEmail,
            selectedRole,
            skills
          );

          if (generatedFeedback && validateWordCount(generatedFeedback)) {
            document.getElementById("detailed-feedback").value =
              generatedFeedback;
            showToast("✅ Feedback generated!", "success");
          } else {
            showToast(
              "⚠️ Feedback generation incomplete or too short. Please review.",
              "error"
            );
            document.getElementById("detailed-feedback").value =
              generatedFeedback || "";
          }
        });
    </script>
  </body>
</html>
