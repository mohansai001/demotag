<!DOCTYPE html>
<html>
  <head>
    <title>Recruitment Portal</title>
    <link href="./tag.css" rel="stylesheet" type="text/css" />
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <style>
      /* Popup Styles */
      .popup {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    width: 200px;
    padding: 15px;
    text-align: center;
    font-size: 14px;
  }
  .popup h3 {
    margin: 0;
    font-size: 16px;
    color: #333;
  }
  .popup p {
    margin: 8px 0;
    font-size: 12px;
    color: #555;
  }
  .popup button {
    margin-top: 10px;
    padding: 5px 10px;
    font-size: 12px;
    background-color: #0078d7;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .popup button:hover {
    background-color: #005a9e;
  }
  /* Dim background */
  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.2);
    z-index: 999;
  }

    </style>
  </head>
  <body>
    <div
      class="image"
      style="max-width: 46%; margin-top: 55px; position: fixed"
    >
      <img src="logo.png" alt="Logo" style="max-width: 100%; height: auto" />
    </div>

    <div id="login-container">
      <h1 style="text-align: center">
        Welcome To Engineering Center's Recruitment Portal
      </h1>

      <form id="login-form">
        <label for="team-select">Select Your Team:</label>
        <select
          id="team-select"
          required
          style="width: 270px; text-align: center; margin-inline: auto"
        >
          <option value="">Select Your Team</option>
          <option value="tag">TAG Team</option>
          <option value="panel">Panel Login</option>
        </select>
        <button type="button" id="msal-login-button" style="width: 53%">
          Login
        </button>
      </form>
    </div>

    <!-- Popup Modal -->
    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
      <h3 id="popup-title">Message</h3>
      <p id="popup-message">This is the popup message.</p>
      <button id="popup-close">Close</button>
    </div>

    <script>
      // MSAL Configuration
      const msalConfig = {
        auth: {
          clientId: "ed0b1bf7-b012-4e13-a526-b696932c0673", // Replace with your Azure AD app client ID
          authority:
            "https://login.microsoftonline.com/13085c86-4bcb-460a-a6f0-b373421c6323", // Replace with your tenant ID
          redirectUri: "https://demotag.vercel.app", // Ensure this matches Azure AD's redirect URI
        },
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      // Scopes
      const loginRequest = {
        scopes: ["openid", "profile", "user.read"], // Add other scopes as needed
      };

      // Popup Utility Functions
      const overlay = document.getElementById("overlay");
      const popup = document.getElementById("popup");
      const popupTitle = document.getElementById("popup-title");
      const popupMessage = document.getElementById("popup-message");
      const popupClose = document.getElementById("popup-close");

      function showPopup(title, message) {
        popupTitle.textContent = title;
        popupMessage.textContent = message;
        overlay.style.display = "block";
        popup.style.display = "block";
      }

      function closePopup() {
        overlay.style.display = "none";
        popup.style.display = "none";
      }

      popupClose.addEventListener("click", closePopup);

      // Handle Login Button Click
      const loginButton = document.getElementById("msal-login-button");
      loginButton.addEventListener("click", async function () {
        const team = document.getElementById("team-select").value;

        if (!team) {
          showPopup("Error", "Please select a team.");
          return;
        }

        try {
          const loginResponse = await msalInstance.loginPopup(loginRequest);
          const account = loginResponse.account;

          if (account) {
            const email = account.username; // Get the user's email
            showPopup("Welcome", `Welcome, ${account.name}!`);

            // Check if the email is in the admin_table
            const response = await fetch(
              "https://demotag.vercel.app/api/check-admin",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ email }),
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              showPopup("Error", errorData.error || "Error checking admin access.");
              return;
            }

            const { ec_mapping } = await response.json();
            showPopup("EC Mapping", `EC Mapping: ${ec_mapping}`);

            // Redirect based on the selected team, passing the ec_mapping as a query parameter
            if (team === "tag") {
              window.location.href = `Dashboard.html?ec_mapping=${encodeURIComponent(
                ec_mapping
              )}`; // Redirect to Dashboard for TAG Team
            } else if (team === "panel") {
              window.location.href = `panelpage.html?ec_mapping=${encodeURIComponent(
                ec_mapping
              )}`; // Redirect to Panel Page for Panel Login
            }
          }
        } catch (error) {
          console.error("Login failed:", error);
          if (error instanceof msal.InteractionRequiredAuthError) {
            showPopup("Error", "Interaction required for login. Please try again.");
          } else {
            showPopup(
              "Error",
              "Authentication failed. Please check your network or contact support."
            );
          }
        }
      });
    </script>
  </body>
</html>
