<!DOCTYPE html>
<html>
  <head>
    <title>Recruitment Portal</title>
    <link href="./tag.css" rel="stylesheet" type="text/css" />
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <style>
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        
      }
      .modal-content {
        background-color: #fff;
        color:black;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        border-radius: 8px;
        text-align: center;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div
      class="image"
      style="max-width: 46%; margin-top: 55px; position: fixed"
    >
      <img src="logo.png" alt="Logo" style="max-width: 100%; height: auto" />
    </div>

    <div id="login-container">
      <h1 style="text-align: center">
        Welcome To Engineering Center's Recruitment Portal
      </h1>

      <form id="login-form">
        <label for="team-select">Select Your Team:</label>
        <select
          id="team-select"
          required
          style="width: 270px; text-align: center; margin-inline: auto"
        >
          <option value="">Select Your Team</option>
          <option value="tag">TAG Team</option>
          <option value="panel">Panel Login</option>
        </select>
        <button type="button" id="msal-login-button" style="width: 53%">
          Login
        </button>
      </form>
    </div>

    <!-- Modal -->
    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p id="modal-text">This is a modal message.</p>
      </div>
    </div>

    <script>
      // MSAL Configuration
      const msalConfig = {
        auth: {
          clientId: "ed0b1bf7-b012-4e13-a526-b696932c0673", // Replace with your Azure AD app client ID
          authority:
            "https://login.microsoftonline.com/13085c86-4bcb-460a-a6f0-b373421c6323", // Replace with your tenant ID
          redirectUri: "https://demotag.vercel.app", // Ensure this matches Azure AD's redirect URI
        },
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      // Scopes
      const loginRequest = {
        scopes: ["openid", "profile", "user.read"], // Add other scopes as needed
      };

      // Modal Script
      const modal = document.getElementById("myModal");
      const modalText = document.getElementById("modal-text");
      const closeModal = document.querySelector(".close");

      closeModal.onclick = () => {
        modal.style.display = "none";
      };

      window.onclick = (event) => {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      function showModal(message) {
        modalText.textContent = message;
        modal.style.display = "block";
      }

      // Handle Login Button Click
      const loginButton = document.getElementById("msal-login-button");
      loginButton.addEventListener("click", async function () {
        const team = document.getElementById("team-select").value;

        if (!team) {
          showModal("Please select a team.");
          return;
        }

        try {
          const loginResponse = await msalInstance.loginPopup(loginRequest);
          const account = loginResponse.account;

          if (account) {
            const email = account.username; // Get the user's email
            showModal(`Welcome, ${account.name}!`);

            // Check if the email is in the admin_table
            const response = await fetch(
              "https://demotag.vercel.app/api/check-admin",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ email }),
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              showModal(errorData.error || "Error checking admin access.");
              return;
            }

            const { ec_mapping } = await response.json();
            showModal(`EC Mapping: ${ec_mapping}`);

            // Redirect based on the selected team, passing the ec_mapping as a query parameter
            if (team === "tag") {
              window.location.href = `Dashboard.html?ec_mapping=${encodeURIComponent(
                ec_mapping
              )}`; // Redirect to Dashboard for TAG Team
            } else if (team === "panel") {
              window.location.href = `panelpage.html?ec_mapping=${encodeURIComponent(
                ec_mapping
              )}`; // Redirect to Panel Page for Panel Login
            }
          }
        } catch (error) {
          console.error("Login failed:", error);
          if (error instanceof msal.InteractionRequiredAuthError) {
            showModal("Interaction required for login. Please try again.");
          } else {
            showModal(
              "Authentication failed. Please check your network or contact support."
            );
          }
        }
      });
    </script>
  </body>
</html>
