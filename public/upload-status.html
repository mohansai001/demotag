<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Results</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
      /* Table Styles */

      .styled-table {
        width: 100%;
        border-collapse: collapse;
        margin: 25px 0;
        font-size: 0.9em;
        font-family: sans-serif;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
      }
      .styled-table thead tr {
        background-color: #009879;
        color: #ffffff;
        text-align: left;
      }
      .styled-table th,
      .styled-table td {
        padding: 12px 15px;
      }
      .styled-table tbody tr {
        border-bottom: 1px solid #dddddd;
      }
      .styled-table tbody tr:nth-of-type(even) {
        background-color: #f3f3f3;
      }
      .styled-table tbody tr:last-of-type {
        border-bottom: 2px solid #009879;
      }
      .status-completed {
        color: green;
      }
      .status-failed {
        color: red;
      }
      .status-processing {
        color: orange;
      }
      .view-btn {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 2px 1px;
        cursor: pointer;
        border-radius: 3px;
      }
      .view-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .back-btn {
        background-color: #555;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 20px;
      }

      /* Loading and Error States */
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 1.2em;
        color: #666;
      }
      .error-message {
        background-color: #ffeeee;
        border: 1px solid #ffcccc;
        border-radius: 5px;
        padding: 20px;
        margin: 20px 0;
        color: #cc0000;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none;
      }
      .show-results-btn {
        background-color: #555;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 20px 0;
      }

      /* Evaluation Results Styles */
      .evaluation-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .evaluation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .evaluation-title {
        font-size: 1.5em;
        color: #333;
      }
      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        font-weight: bold;
      }
      .status-shortlisted {
        background-color: #34a853;
        color: white;
      }
      .status-rejected {
        background-color: #ea4335;
        color: white;
      }
      .evaluation-section {
        margin-bottom: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .section-header {
        background: #daf7a6;
        color: black;
        padding: 12px 20px;
        font-size: 1.1em;
        font-weight: bold;
      }
      .section-content {
        padding: 15px 20px;
        line-height: 1.6;
        color: #333;
      }
      .section-content pre {
        white-space: pre-wrap;
        font-family: inherit;
        margin: 0;
      }
      .section-content ul {
        padding-left: 20px;
        margin: 10px 0;
      }
      .section-content li {
        margin-bottom: 5px;
      }
      .action-buttons {
        display: flex;
        justify-content: space-between;
        padding: 20px;
        background: #f9f9f9;
        border-top: 1px solid #eee;
      }
      .download-btn {
        background-color: #daf7a6;
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .next-btn {
        background-color: #daf7a6;
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .back-to-results-btn {
        background-color: #daf7a6;
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 20px;
        display: block;
        width: 200px;
        margin-left: auto;
        margin-right: auto;
      }
      /* üîí Modal container */
      .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
      }

      /* ‚úÖ Hidden class */
      .custom-modal.hidden {
        display: none;
      }

      /* üì¶ Modal box */
      .custom-modal-content {
        background: #fff;
        padding: 30px 40px;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        max-width: 550px;
        width: 90%;
        text-align: center;
        animation: slideIn 0.3s ease;
      }

      /* üöÄ Slide-in animation */
      @keyframes slideIn {
        from {
          transform: translateY(-30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* ‚úâÔ∏è List of duplicate emails */
      .duplicate-email-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
        max-height: 200px;
        overflow-y: auto;
        text-align: left;
      }
      .duplicate-email-list li {
        padding: 8px;
        background: #f8f8f8;
        margin-bottom: 5px;
        border-radius: 5px;
        font-size: 15px;
      }

      /* üîò Buttons */
      .modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
      }
      .modal-button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        font-size: 15px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      .fetch-btn {
        background-color: #1976d2;
        color: white;
      }
      .fetch-btn:hover {
        background-color: #125aa3;
      }
      .close-btn {
        background-color: #e53935;
        color: white;
      }
      .close-btn:hover {
        background-color: #b71c1c;
      }

      #duplicateEmailList {
        list-style: none;
        padding: 0;
        margin: 12px 0;
        max-height: 200px;
        overflow-y: auto;
      }
      .disable-column td:last-child {
        pointer-events: none;
        opacity: 0.4;
      }
      .sidebar-menu {
        width: 14.8%;
        position: fixed;
        top: 0px;
        left: 0;
        height: 90%;
        margin-top: 55px;
        transition: transform 0.3s ease;
        transform: translateX(-100%);
        border: 2px solid;
        background: white;
        z-index: 1001;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        /* Stack items vertically */
        justify-content: flex-start;
        border-radius: 5px;
      }

      .sidebar-menu.show {
        transform: translateX(0);
        /* Show the sidebar */
      }

      .logout-option {
        margin-top: auto;
        /* Push the logout option to the bottom */
        padding: 15px 20px;
        /* Ensure padding on the logout item */
        display: flex;
        align-items: center;
        width: 100%;
        /* Full width of the sidebar */
        cursor: pointer;
      }

      .logout-option i {
        margin-right: 10px;
        /* Space between icon and text */
      }

      #toggle-sidebar-btn {
        position: fixed;
        top: 10px;
        background-color: white;
        color: black;
        border: none;
        /* padding: 10px 15px; */
        cursor: pointer;
        font-size: 18px;
        width: 15%;
        border-radius: 4px;
        height: 41px;
        z-index: 1002;
      }

      .sidebar-option {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        /* Smooth transitions for all properties */
        position: relative;
        width: 81%;
        color: black;
        border-radius: 5px;
        /* Adds rounded corners */
      }

      .sidebar-option i {
        margin-right: 10px;
        /* Space between icon and text */
      }

      .sidebar-option:hover {
        background-color: #daf7a6;
        /* Light gray hover background */
        color: black;
        /* Text changes to blue */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        /* Subtle shadow */
        transform: translateY(-2px);
        /* Slight upward movement */
      }

      .sidebar-option::before {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0;
        width: 0;
        height: 3px;
        background-color: black;
        /* Highlight bar color */
        transition: width 0.3s ease;
      }

      .sidebar-option:hover::before {
        width: 100%;
        /* Expands the highlight bar */
      }

      .chip {
        display: inline-block;
        margin-left: 10px;
        /* Adjust spacing from the Dashboard */
        padding: 5px 10px;
        font-size: 8px;
        font-weight: bold;
        color: white;
        background-color: grey;
        /* Orange color for 'Coming Soon' */
        border-radius: 15px;
        transition: background-color 0.3s ease;
      }

      .chip.primary {
        background-color: grey;
        /* Define your primary color */
      }
    </style>
  </head>
  <body>
    <!-- Toast and Toggle Button -->

    <button id="toggle-sidebar-btn" onclick="toggleSidebar()">‚ò∞ Menu</button>

    <!-- Sidebar Menu -->
    <div id="sidebar" class="sidebar-menu hidden">
      <div class="sidebar-option active" onclick="navigateTo('Dashboard.html')">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </div>
      <div class="sidebar-option" onclick="navigateTo('Excelread.html')">
        <i class="fas fa-file-upload"></i>
        <span>Upload RRF</span>
      </div>
      <div
        class="sidebar-option"
        onclick="navigateWithECMapping('ECselection.html')"
      >
        <i class="fas fa-users"></i>
        <span>Recruit</span>
      </div>
      <div class="sidebar-option" onclick="navigateTo('candidatespage.html')">
        <i class="fas fa-tasks"></i>
        <span>RRF Tracking</span>
      </div>
      <div class="sidebar-option" onclick="navigateTo('GTPrescreening.html')">
        <i class="fas fa-clipboard-check"></i>
        <span>GT's Prescreening</span>
      </div>
      <div
        class="sidebar-option"
        onclick="navigateTo('interview-schedule.html')"
      >
        <i class="fas fa-calendar-alt"></i>
        <span>My Interviews</span>
      </div>
      <div
        class="sidebar-option logout-option"
        onclick="navigateTo('index.html')"
      >
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </div>
    </div>

    <!-- üîÅ Duplicate Candidates Modal -->
    <div id="emailModal" class="custom-modal hidden">
      <div class="custom-modal-content">
        <h2>‚ö†Ô∏è Duplicate Candidates Detected</h2>
        <p>The following candidates have already been evaluated:</p>

        <ul id="duplicateEmailList" class="duplicate-email-list"></ul>

        <div class="modal-actions">
          <button
            class="modal-button fetch-btn"
            onclick="fetchExistingCandidates()"
          >
            üîç View Existing Records
          </button>
          <button class="modal-button close-btn" onclick="closeModal()">
            ‚ùå Close
          </button>
        </div>
      </div>
    </div>

    <h1 style:margin-left: 40%;>Analysis Result</h1>
    <!-- Add this right after the <h1>Analysis Results</h1> -->
    <div style="margin: 20px 0; display: flex; align-items: center; gap: 10px">
      <label for="date-filter">Filter by Date:</label>
      <input type="date" id="date-filter" onchange="filterByDate()" />
      <button onclick="clearDateFilter()" style="padding: 5px 10px">
        Clear Filter
      </button>
    </div>
    <div id="results-table-container">
      <table id="upload-table" class="styled-table">
        <thead>
          <tr>
            <th>Candidate Name</th>
            <th>Resume Name</th>
            <th>RRF ID</th>
            <th>Analysis Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="upload-table-body">
          <tr>
            <td colspan="5" class="loading">
              <div class="spinner"></div>
              <p>Loading candidate data...</p>
            </td>
          </tr>
        </tbody>
      </table>
      <button class="back-btn" onclick="window.location.href='apprecruit.html'">
        Back to Upload
      </button>
    </div>

    <div id="evaluation-result-container" class="hidden"></div>
    <button
      hidden
      id="show-results-btn"
      class="show-results-btn hidden"
      onclick="showResultsTable()"
    >
      Back to Results Table
    </button>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const tableBody = document.getElementById("upload-table-body");

        // Show loading spinner initially
        tableBody.innerHTML = `
    <tr>
      <td colspan="5" class="loading">
        <div class="spinner"></div>
        <p>Loading candidate data...</p>
      </td>
    </tr>`;

        // Disable all View buttons + dim Action column
        document
          .querySelector("#upload-table-body")
          ?.classList.add("disable-column");
        document
          .querySelectorAll(".view-btn")
          .forEach((btn) => (btn.disabled = true));

        try {
          // Load candidates from DB
          const response = await fetch(
            "https://demotag.vercel.app/api/get/candidate-info"
          );
          if (!response.ok)
            throw new Error(`Failed to load candidates: ${response.status}`);
          const result = await response.json();
          if (!result.success || !Array.isArray(result.data))
            throw new Error("Invalid data format");

          const candidates = result.data;
          tableBody.innerHTML = "";

          if (candidates.length > 0) {
            renderCandidateTable(candidates);
          }

          // Process in-memory uploaded resumes
          const multiUploadFiles = JSON.parse(
            sessionStorage.getItem("multiUploadFiles") || "[]"
          );
          const multiUploadData = JSON.parse(
            localStorage.getItem("multiUploadData") || "{}"
          );

          if (!multiUploadData || multiUploadFiles.length === 0) {
            // ‚úÖ No new resumes to process, re-enable everything
            document
              .querySelectorAll(".view-btn")
              .forEach((btn) => (btn.disabled = false));
            document
              .querySelector("#upload-table-body")
              ?.classList.remove("disable-column");
            return;
          }

          let completedCount = 0;
          const totalFiles = multiUploadFiles.length;

          for (let i = 0; i < totalFiles; i++) {
            const fileData = multiUploadFiles[i];
            const fileName = fileData.name;

            // Skip already existing rows
            const alreadyExists = Array.from(
              document.querySelectorAll("#upload-table-body tr td:nth-child(2)")
            ).some((td) => td.textContent.trim() === fileName);
            if (alreadyExists) {
              completedCount++;
              continue;
            }

            const row = document.createElement("tr");
            row.id = `file-row-${i}`;
            row.innerHTML = `
        <td>Processing...</td>
        <td>${fileName}</td>
        <td>${multiUploadData.rrfId || "N/A"}</td>
        <td class="status-cell status-processing" id="status-${i}">
          <div class="spinner" style="width: 16px; height: 16px;"></div> Processing...
        </td>
        <td><button class="view-btn" id="view-btn-${i}" disabled>View</button></td>
      `;
            tableBody.appendChild(row);

            const statusCell = document.getElementById(`status-${i}`);
            const viewBtn = document.getElementById(`view-btn-${i}`);

            try {
              const fileBlob = await fetch(fileData.dataUrl).then((r) =>
                r.blob()
              );
              let file = new File([fileBlob], fileName, {
                type: fileBlob.type,
              });

              // Convert if needed
              if (fileName.endsWith(".doc")) {
                file = await convertDocToPdf(file);
              } else if (fileName.endsWith(".docx")) {
                file = await convertDocxToPdf(file);
              }

              const timestamp = Date.now();
              const newFileName = `${timestamp}_${file.name.replace(
                /\.[^/.]+$/,
                ".pdf"
              )}`;
              const githubUrl = await uploadToGitHub(newFileName, file);

              // Set globals
              const {
                hrEmail,
                rrfId,
                selectedValue,
                selectedRole,
                globalSelectedLevel,
                selectedCloudProvider,
                globalJobDescription,
              } = multiUploadData;

              window.globalHrEmail = hrEmail;
              window.globalRrfId = rrfId;
              window.selectedValue = selectedValue;
              window.selectedRole = selectedRole;
              window.globalSelectedLevel = globalSelectedLevel;
              window.selectedCloudProvider = selectedCloudProvider;
              window.globalJobDescription = globalJobDescription;

              const evaluation = await evaluateResumeWithChatPDF(githubUrl);

              statusCell.innerHTML = "Completed";
              statusCell.className = "status-cell status-completed";
              viewBtn.disabled = false;

              viewBtn.onclick = () => {
                displayEvaluationResults(
                  evaluation,
                  githubUrl,
                  hrEmail,
                  rrfId,
                  selectedValue,
                  selectedRole,
                  globalSelectedLevel,
                  selectedCloudProvider
                );
              };
            } catch (err) {
              console.error("‚ùå Failed to process:", fileName, err);
              statusCell.innerHTML = "Failed";
              statusCell.className = "status-cell status-failed";
              viewBtn.disabled = true;
            }

            completedCount++;

            // ‚úÖ When all resumes processed, enable all buttons
            if (completedCount === totalFiles) {
              setTimeout(() => {
                document
                  .querySelectorAll(".view-btn")
                  .forEach((btn) => (btn.disabled = false));
                document
                  .querySelector("#upload-table-body")
                  ?.classList.remove("disable-column");
              }, 5000);
            }
          }

          // Cleanup session/local data
          localStorage.removeItem("multiUploadData");
          sessionStorage.removeItem("multiUploadFiles");
        } catch (error) {
          console.error("Error loading candidate data:", error);
          showErrorMessage(error.message);
        }
      });

      function renderCandidateTable(candidates) {
        const tableBody = document.getElementById("upload-table-body");
        tableBody.innerHTML = "";

        candidates.forEach((candidate) => {
          const row = document.createElement("tr");
          row.id = `candidate-${candidate.id}`;
          row.innerHTML = `
            <td>${candidate.candidate_name || "Unknown"}</td>
            <td>${extractFilename(candidate.resume) || "N/A"}</td>
            <td>${candidate.rrf_id || "N/A"}</td>
            <td class="status-cell ${getStatusClass(
              candidate.prescreening_status
            )}">
              ${candidate.prescreening_status || "Pending"}
            </td>
            <td>
              <button class="view-btn" 
                onclick="viewCandidateEvaluation(${candidate.id})"
                ${
                  !candidate.prescreening_status ||
                  candidate.prescreening_status === "Pending"
                    ? "disabled"
                    : ""
                }>
                View Analysis
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      function extractFilename(url) {
        if (!url) return null;
        // Extract filename from URL
        const parts = url.split("/");
        return parts[parts.length - 1];
      }

      async function viewCandidateEvaluation(candidateId) {
        try {
          // Hide table and show loading spinner
          document
            .getElementById("results-table-container")
            .classList.add("hidden");
          document
            .getElementById("evaluation-result-container")
            .classList.remove("hidden");
          document
            .getElementById("show-results-btn")
            .classList.remove("hidden");

          const container = document.getElementById(
            "evaluation-result-container"
          );
          // container.innerHTML = `
          //   <div class="loading">
          //     <div class="spinner"></div>
          //     <p>Loading evaluation data...</p>
          //   </div>`;

          // Fetch data
          const response = await fetch(
            `https://demotag.vercel.app/api/get/candidate-evaluation/${candidateId}`
          );

          if (!response.ok) {
            throw new Error(`Failed to load evaluation: ${response.status}`);
          }

          const result = await response.json();

          if (!result.success || !result.data) {
            throw new Error(result.message || "Evaluation data not found");
          }

          const evaluation = result.data;

          // Store evaluation data in localStorage
          localStorage.setItem("evaluationData", JSON.stringify(evaluation));

          // Display the evaluation
          displayEvaluationResults(
            evaluation.content,
            evaluation.resume_url,
            evaluation.hr_email,
            evaluation.rrf_id,
            evaluation.eng_center,
            evaluation.role,
            evaluation.level,
            evaluation.cloud_provider,
            evaluation.prescreening_status
          );
        } catch (error) {
          console.error("Error viewing evaluation:", error);
          showEvaluationError(error.message);
        }
      }

      function displayEvaluationResults(
        content,
        resumeUrl,
        hrEmail,
        rrfId,
        selectedValue,
        selectedRole,
        globalSelectedLevel,
        selectedCloudProvider,
        prescreening_status // ‚úÖ NEW PARAM
      ) {
        const container = document.getElementById(
          "evaluation-result-container"
        );

        const isShortlisted = prescreening_status === "Shortlisted";

        container.innerHTML = `
    <div class="evaluation-container">
      <div class="evaluation-header">
        <h2 class="evaluation-title">Candidate Analysis Report</h2>
        <span class="status-badge ${
          isShortlisted ? "status-shortlisted" : "status-rejected"
        }">
          ${isShortlisted ? "Shortlisted" : "Rejected"}
        </span>
      </div>

      <div class="evaluation-section">
        <div class="section-header">Basic Information</div>
        <div class="section-content">
          <p><strong>Resume:</strong> ${extractFilename(resumeUrl)}</p>
          <p><strong>RRF ID:</strong> ${rrfId || "N/A"}</p>
          <p><strong>HR Email:</strong> ${hrEmail || "N/A"}</p>
          <p><strong>Engineering Center:</strong> ${selectedValue || "N/A"}</p>
          <p><strong>Role:</strong> ${selectedRole || "N/A"}</p>
          <p><strong>Level:</strong> ${globalSelectedLevel || "N/A"}</p>
          <p><strong>Cloud Provider:</strong> ${
            selectedCloudProvider || "N/A"
          }</p>
        </div>
      </div>

      <div id="evaluation-sections"></div>

      <div class="action-buttons">
        <button class="download-btn" onclick="downloadEvaluationReport(
          ${JSON.stringify(content)},
          ${JSON.stringify(selectedValue)},
          ${JSON.stringify(selectedRole)},
          ${JSON.stringify(globalSelectedLevel)},
          ${JSON.stringify(selectedCloudProvider)}
        )">
          Download Full Report
        </button>

        ${
          isShortlisted
            ? `<button class="next-btn" onclick="window.location.href='prescreeningform.html'">
                 Proceed to Next Step
               </button>`
            : ""
        }
      </div>

      <button class="back-to-results-btn" onclick="showResultsTable()">
        Back to Candidates List
      </button>
    </div>
  `;

        const sectionsContainer = container.querySelector(
          "#evaluation-sections"
        );
        const sections = parseEvaluationContent(content);

        sections.forEach((section) => {
          if (!section.content.trim()) return;

          const sectionElement = document.createElement("div");
          sectionElement.className = "evaluation-section";
          sectionElement.innerHTML = `
      <div class="section-header">${section.title}</div>
      <div class="section-content">
        ${formatSectionContent(section.content)}
      </div>
    `;
          sectionsContainer.appendChild(sectionElement);
        });
      }
      function parseEvaluationContent(content) {
        const sectionTitles = [
          "Candidate Overview",
          "Contact Information",
          "Education",
          "Work Experience",
          "Skills",
          "Achievements",
          "Candidate Stability",
          "Skill Gaps",
          "Result",
        ];

        const sections = [];
        let currentSection = { title: "Evaluation", content: "" };

        content.split("\n").forEach((line) => {
          const trimmedLine = line.trim();
          const matchedTitle = sectionTitles.find(
            (title) =>
              trimmedLine.startsWith(title) || trimmedLine.includes(title)
          );

          if (matchedTitle) {
            if (currentSection.content) {
              sections.push(currentSection);
            }
            currentSection = { title: matchedTitle, content: "" };
          } else {
            currentSection.content += line + "\n";
          }
        });

        if (currentSection.content) {
          sections.push(currentSection);
        }

        return sections;
      }

      function formatSectionContent(content) {
        // Convert markdown-style lists to HTML
        let htmlContent = content
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/^‚Ä¢ (.*$)/gm, "<li>$1</li>")
          .replace(/^- (.*$)/gm, "<li>$1</li>")
          .replace(/^\* (.*$)/gm, "<li>$1</li>");

        // Group list items into proper UL tags
        if (htmlContent.includes("<li>")) {
          htmlContent =
            "<ul>" +
            htmlContent.replace(/<\/li>\s*<li>/g, "</li><li>") +
            "</ul>";
        }

        // Preserve line breaks
        htmlContent = htmlContent.replace(/\n/g, "<br>");

        return htmlContent;
      }

      function downloadEvaluationReport(
        content,
        selectedValue,
        selectedRole,
        level,
        cloudProvider
      ) {
        // This would call your existing downloadContentAsFile function
        console.log("Downloading evaluation report...");
        // Implement your download functionality here
      }

      function showResultsTable() {
        document
          .getElementById("results-table-container")
          .classList.remove("hidden");
        document
          .getElementById("evaluation-result-container")
          .classList.add("hidden");
        document.getElementById("show-results-btn").classList.add("hidden");
        document.getElementById("evaluation-result-container").innerHTML = "";
      }

      function getStatusClass(status) {
        if (!status) return "";
        switch (status.toLowerCase()) {
          case "shortlisted":
            return "status-completed";
          case "rejected":
            return "status-failed";
          case "pending":
            return "status-processing";
          default:
            return "";
        }
      }

      function showNoDataMessage(message) {
        const tableBody = document.getElementById("upload-table-body");
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">
              ${message}
              <button onclick="window.location.reload()">Retry</button>
            </td>
          </tr>`;
      }

      function showErrorMessage(message) {
        const tableBody = document.getElementById("upload-table-body");
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: red;">
              Error: ${message}
              <button onclick="window.location.reload()">Retry</button>
            </td>
          </tr>`;
      }

      function showEvaluationError(message) {
        const container = document.getElementById(
          "evaluation-result-container"
        );
        container.innerHTML = `
          <div class="error-message">
            <h3>Error Loading Evaluation</h3>
            <p>${message}</p>
            <button onclick="showResultsTable()">Back to Results</button>
          </div>`;
      }
      async function uploadResume() {
        const fileInput = document.getElementById("resume");
        const files = fileInput.files;
        const hrEmail = document.getElementById("hr-email").value;
        const rrfId = document.getElementById("RRF-ID").value;

        if (!hrEmail || !validateEmail(hrEmail)) {
          displaySuccessPopup("Please enter a valid HR email.");
          return;
        }

        if (!files || files.length === 0) {
          displaySuccessPopup("Please upload at least one document file.");
          return;
        }

        globalHrEmail = hrEmail;
        globalRrfId = rrfId;

        // Store necessary data for use in upload-status.html
        const initialData = {
          hrEmail: globalHrEmail,
          rrfId: globalRrfId,
          selectedValue: selectedValue,
          selectedRole: selectedRole,
          selectedCloudProvider: selectedCloudProvider,
          globalSelectedLevel: globalSelectedLevel,
          globalfrontendTechnology: globalfrontendTechnology,
          fileEvaluations: {},
          timestamp: new Date().toISOString(),
        };

        Array.from(files).forEach((file, index) => {
          initialData.fileEvaluations[index] = {
            fileName: file.name,
            status: "Queued",
            content: null,
            resumeUrl: null,
          };
        });

        // Save file list and data to localStorage for access in upload-status.html
        localStorage.setItem("multiUploadData", JSON.stringify(initialData));

        // Save the actual File objects separately using the FileReader and sessionStorage
        // since localStorage doesn't support File objects directly
        const fileReaders = Array.from(files).map((file) => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              resolve({ name: file.name, dataUrl: event.target.result });
            };
            reader.readAsDataURL(file);
          });
        });

        const fileDataArray = await Promise.all(fileReaders);
        sessionStorage.setItem(
          "multiUploadFiles",
          JSON.stringify(fileDataArray)
        );

        // Navigate to the status page
        window.location.href = "upload-status.html";
      }
      document.addEventListener("DOMContentLoaded", async () => {
        const multiUploadData = JSON.parse(
          localStorage.getItem("multiUploadData")
        );
        const multiUploadFiles = JSON.parse(
          sessionStorage.getItem("multiUploadFiles")
        );

        if (!multiUploadData || !multiUploadFiles) return;

        const tableBody = document.getElementById("upload-table-body");
        tableBody.innerHTML = ""; // Clear previous loading rows

        for (let i = 0; i < multiUploadFiles.length; i++) {
          const fileData = multiUploadFiles[i];
          const fileName = fileData.name;

          const row = document.createElement("tr");
          row.id = `file-row-${i}`;
          row.innerHTML = `
      <td>Processing...</td>
      <td>${fileName}</td>
      <td>${multiUploadData.rrfId || "N/A"}</td>
      <td class="status-cell status-processing" id="status-${i}">Queued</td>
      <td><button class="view-btn" id="view-btn-${i}" disabled>View</button></td>
    `;
          tableBody.appendChild(row);

          const statusCell = document.getElementById(`status-${i}`);
          const viewBtn = document.getElementById(`view-btn-${i}`);

          try {
            // Disable button while processing
            viewBtn.disabled = true;

            const response = await fetch(fileData.dataUrl);
            const blob = await response.blob();
            let file = new File([blob], fileName, { type: blob.type });

            // Convert .doc/.docx
            if (fileName.endsWith(".doc")) {
              file = await convertDocToPdf(file);
            } else if (fileName.endsWith(".docx")) {
              file = await convertDocxToPdf(file);
            }

            const timestamp = Date.now();
            const newFileName = `${timestamp}_${file.name.replace(
              /\.[^/.]+$/,
              ".pdf"
            )}`;
            const githubUrl = await uploadToGitHub(newFileName, file);

            // Set globals
            const {
              hrEmail,
              rrfId,
              selectedValue,
              selectedRole,
              globalSelectedLevel,
              selectedCloudProvider,
              globalJobDescription,
            } = multiUploadData;

            window.globalHrEmail = hrEmail;
            window.globalRrfId = rrfId;
            window.selectedValue = selectedValue;
            window.selectedRole = selectedRole;
            window.globalSelectedLevel = globalSelectedLevel;
            window.selectedCloudProvider = selectedCloudProvider;
            window.globalJobDescription = globalJobDescription;

            const evaluation = await evaluateResumeWithChatPDF(githubUrl);

            statusCell.textContent = "Completed";
            statusCell.className = "status-cell status-completed";
            viewBtn.disabled = false; // ‚úÖ Enable after success

            viewBtn.onclick = () => {
              displayEvaluationResults(
                evaluation,
                githubUrl,
                hrEmail,
                rrfId,
                selectedValue,
                selectedRole,
                globalSelectedLevel,
                selectedCloudProvider
              );
            };
          } catch (err) {
            console.error("‚ùå Failed to process:", fileName, err);
            statusCell.textContent = "Failed";
            statusCell.className = "status-cell status-failed";
            viewBtn.disabled = true;
          }
        }

        // Cleanup
        localStorage.removeItem("multiUploadData");
        sessionStorage.removeItem("multiUploadFiles");
      });

      // Add this with your other functions
      async function filterByDate() {
        const dateInput = document.getElementById("date-filter");
        const selectedDate = dateInput.value;

        if (!selectedDate) {
          return;
        }

        try {
          const tableBody = document.getElementById("upload-table-body");
          tableBody.innerHTML = `
      <tr>
        <td colspan="5" class="loading">
          <div class="spinner"></div>
          <p>Loading filtered candidates...</p>
        </td>
      </tr>`;

          const response = await fetch(
            `https://demotag.vercel.app/api/get/candidate-infos?date=${selectedDate}`
          );
          if (!response.ok)
            throw new Error(`Failed to load candidates: ${response.status}`);

          const result = await response.json();
          if (!result.success || !Array.isArray(result.data))
            throw new Error("Invalid data format");

          const candidates = result.data;
          tableBody.innerHTML = "";

          if (candidates.length > 0) {
            renderCandidateTable(candidates);
          } else {
            showNoDataMessage(`No candidates found for ${selectedDate}`);
          }
        } catch (error) {
          console.error("Error filtering by date:", error);
          showErrorMessage(error.message);
        }
      }

      function clearDateFilter() {
        document.getElementById("date-filter").value = "";
        window.location.reload(); // Reload to show all records
      }
    </script>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

    <script src="javascript/apprecruit.js" defer></script>

    <!-- ‚úÖ Loading Overlay for Resume Evaluation -->
    <!-- <div
      id="loading-popup"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      "
    > -->
    <!-- <div
        class="spinner"
        style="
          border: 6px solid #f3f3f3;
          border-top: 6px solid #3498db;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
        "
      ></div>
      <p style="margin-top: 15px">Evaluating resume, please wait...</p>
    </div>

    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style> -->
  </body>
</html>
