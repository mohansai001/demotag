<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assessment & Feedback Form</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      body,
      html {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(120deg, #e6e6fa, #daf7a6);
        color: #e0e0e0;
        height: 100%;
      }

      :root {
        --primary-color: #4a90e2;
        --secondary-color: #f5a623;
        --background-color: black;
        --text-color: #333;
        --border-color: #d1d5db;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-left: 325px;
      }

      h1 {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      h2 {
        font-size: 1.5rem;
        color: var(--secondary-color);
        margin-bottom: 1rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: black;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      textarea {
        width: 100%;
        height: 315px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .tabs {
        display: flex;
        overflow-x: auto;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .tab {
        padding: 0.75rem 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .tab.active {
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: 600;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: background-color 0.3s ease;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-secondary {
        background-color: var(--secondary-color);
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      body,
      html {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #e5e4e2;
        color: #e0e0e0;
        height: fit-content;
      }

      .chip {
        display: inline-block;
        margin-left: 10px;
        /* Adjust spacing from the Dashboard */
        padding: 5px 10px;
        font-size: 8px;
        font-weight: bold;
        color: white;
        background-color: grey;
        /* Orange color for 'Coming Soon' */
        border-radius: 15px;
        transition: background-color 0.3s ease;
      }

      .chip.primary {
        background-color: grey;
        /* Define your primary color */
      }

      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      .form-container {
        width: 96%;
        margin: 0 auto;
        border: 1px solid #333;
        padding: 20px;
        box-sizing: border-box;
        /* margin-left: 174px; */

        background-color: white;
      }

      .form-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .form-header .form-group {
        width: 48%;
        margin-bottom: 10px;
      }

      .form-header .form-group label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }

      .form-header .form-group input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }

      .rating-section {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        font-weight: bold;
        background-color: #1f4e79;
        padding: 10px;
        border: 1px solid #333;
      }

      .skills-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .skills-table th,
      .skills-table td {
        border: 1px solid #333;
        padding: 8px;
        text-align: center;
      }

      .skills-table th {
        background-color: #1f4e79;
        color: white;
      }

      .skills-title {
        text-align: left;
        background-color: white;
        font-weight: bold;
        color: black;
      }

      .form-input,
      .comment-input {
        width: 100%;
        padding: 6px;
        box-sizing: border-box;
      }

      .feedback-section {
        margin-top: 25px;
      }

      .feedback-section-text {
        margin-top: 5px;
      }

      .feedback-section label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }

      .feedback-section textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        min-height: 200px;
        resize: vertical;
      }

      .result-section {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .result-section label {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .result-select {
        padding: 8px;
        width: 100%;
        max-width: 200px;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        display: none;
        z-index: 9999;
      }

      .toast.show {
        display: block;
      }

      .toast.success {
        background-color: #4caf50;
      }

      .toast.error {
        background-color: #f44336;
      }

      .header {
        background-color: white;
        color: black;
        font-weight: bold;
      }

      .details {
        background-color: white;
        color: black;
        font-weight: bold;
        width: 13% !important;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      tr {
        height: 100%;
        /* You can adjust this value as needed */
      }

      td,
      th {
        border: 0.5px solid rgb(136, 136, 136);
        padding: 4px;
        text-align: left;
        color: black;
        height: 100%;
      }

      table td:nth-child(1),
      table th:nth-child(1) {
        width: 8%;
      }

      table td:nth-child(2),
      table th:nth-child(2) {
        width: 15%;
      }

      table td:nth-child(3),
      table th:nth-child(3) {
        width: 4%;
      }

      table td:nth-child(4),
      table th:nth-child(4),
      table td:nth-child(5),
      table th:nth-child(5),
      table td:nth-child(6),
      table th:nth-child(6) {
        width: 6%;
      }

      table td:nth-child(7),
      table th:nth-child(7),
      table td:nth-child(8),
      table th:nth-child(8) {
        width: 23%;
      }
    </style>
  </head>
  <body>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <div id="toast" class="toast"></div>

    <div class="form-container" id="form-container">
      <div style="color: #000000">
        <p>Email: <span id="candidate-email"></span></p>
        <p>iMocha Score: <span id="imocha-score"></span></p>
      </div>
      <br />
      <!-- Header Section -->
      <div style="max-width: 50%">
        <table>
          <tr>
            <td class="details">RRF ID</td>
            <td><input type="text" id="rrf-id" placeholder="" readonly /></td>
          </tr>
          <tr>
            <td class="details">Job Designation</td>
            <td><input type="text" id="position" placeholder="" readonly /></td>
          </tr>
          <tr>
            <td class="details">Name of the Candidate</td>
            <td>
              <input type="text" id="candidate-name" placeholder="" readonly />
            </td>
          </tr>
          <tr>
            <td class="details">Date of Interview</td>
            <td><input type="text" id="interview-date" readonly /></td>
          </tr>
          <tr>
            <td class="details">Interviewer Mail</td>
            <td>
              <input
                type="text"
                id="interviewer-name"
                placeholder=""
                readonly
              />
            </td>
          </tr>
          <tr>
            <td class="details">TAG Team Member</td>
            <td><input type="text" id="hr-email" placeholder="" readonly /></td>
          </tr>
        </table>
      </div>

      <!-- Skills Table -->
      <table id="skills-table">
        <thead>
          <tr style="font-weight: bold; background-color: rgb(187, 187, 187)">
            <td>Skills</td>
            <td>Description</td>
            <td>Top Skills</td>
            <td>Rating</td>
           
            <td>Justification</td>
            <td>Improvements</td>
          </tr>
        </thead>
        <tbody id="skills-table-body">
          <!-- Dynamically populated rows will go here -->
        </tbody>
      </table>

      <!-- Feedback Section -->
      <div class="feedback-section">
        <label for="detailed-feedback">Detailed Feedback: *</label>
        <h3>
          <div
            id="loading-message"
            style="display: none; font-style: italic; color: #00d9ff"
          >
            Please wait while analyzing the feedback based on given inputs...
          </div>
        </h3>
        <textarea
          id="detailed-feedback"
          class="feedback-section-text"
          placeholder="Enter your detailed feedback here..."
          required
        ></textarea>
        <button id="generate-summary">Generate Feedback</button>
      </div>

      <!-- Result Section -->
      <div class="result-section">
        <label for="result">Shortlisted for next round</label>
        <select id="result" class="result-select" required>
          <option value="">Select</option>
          <option value="Recommended">Shortlisted</option>
          <option value="Rejected">Rejected</option>
        </select>
      </div>
      <div style="display: flex; justify-content: center">
        <button
          id="submit-button"
          style="
            background-color: #1f4e79;
            color: #ffffff;
            height: 25px;
            width: 200px;
            border-radius: 5px;
          "
        >
          Submit
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>

    <script>
      const msalConfig = {
        auth: {
          clientId: "ed0b1bf7-b012-4e13-a526-b696932c0673", // Replace with your Azure AD app client ID
          authority:
            "https://login.microsoftonline.com/13085c86-4bcb-460a-a6f0-b373421c6323", // Replace with your tenant ID
          redirectUri: "https://demotag.vercel.app", // Must match the redirect URI registered in Azure AD
        },
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.remove("success", "error");
        toast.classList.add("show");
        toast.classList.add(type);
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const candidateEmail = urlParams.get("candidateEmail");
        const position = urlParams.get("position");
        console.log("Candidate Email:", position);

        if (!candidateEmail) {
          showToast("Candidate email is missing in the URL.", "error");
          return;
        }

        try {
          const candidateResponse = await fetch(
            `/api/getCandidateData?candidateEmail=${encodeURIComponent(
              candidateEmail
            )}`
          );
          if (!candidateResponse.ok)
            throw new Error("Failed to fetch candidate data.");

          const candidateData = await candidateResponse.json();
          if (candidateData.error) {
            showToast(candidateData.error, "error");
            return;
          }

          const candidateId = candidateData.id;
          if (!candidateId)
            throw new Error("Candidate ID not found in response");

          // Populate candidate details
          document.getElementById("candidate-email").textContent =
            candidateEmail;
          document.getElementById("imocha-score").textContent =
            candidateData.l_1_score || "N/A";
          document.getElementById("rrf-id").value =
            candidateData.rrf_id || "N/A";
          document.getElementById("position").value =
            candidateData.role || "N/A";
          document.getElementById("candidate-name").value =
            candidateData.candidate_name || "N/A";
          document.getElementById("interview-date").value =
            candidateData.l_2_interviewdate || "N/A";
          document.getElementById("interviewer-name").value =
            candidateData.panel_name || "N/A";
          document.getElementById("hr-email").value =
            candidateData.hr_email || "N/A";

          if (document.getElementById("candidate-id")) {
            document.getElementById("candidate-id").textContent = candidateId;
          }

          // Position-to-API mapping
          const positionToApiMap = {
            "Junior .Net Cloud Native Application Engineer - Backend":
              "api/dotnet_feedback-questions",
            "Senior .Net Cloud Native Application Engineer - Backend":
              "api/dotnet_feedback-questions",

            "Junior Java Cloud Native Application Engineer - Backend":
              "/api/java_feedback-questions",
            "Senior Java Cloud Native Application Engineer - Backend":
              "/api/java_feedback-questions",

            "Junior Angular Cloud Native Application Engineer - Frontend":
              "/api/angular_feedback-questions",
            "Senior Angular Cloud Native Application Engineer - Frontend":
              "/api/angular_feedback-questions",

            "Junior React Cloud Native Application Engineer - Frontend":
              "/api/react_feedback-questions",
            "Senior React Cloud Native Application Engineer - Frontend":
              "/api/react_feedback-questions",
          };

          const questionsApi =
            positionToApiMap[position] || "/api/app_generic_feedback-questions";

          const questionsResponse = await fetch(questionsApi);
          if (!questionsResponse.ok)
            throw new Error("Failed to fetch feedback questions.");

          const questionsData = await questionsResponse.json();
          populateFeedbackForm(questionsData);

          await fetchAndPopulateExistingFeedback(candidateId, position);
        } catch (error) {
          console.error("Error loading data:", error);
          // showToast(`Failed to load data: ${error.message}`, "error");
        }
      });

      async function fetchAndPopulateExistingFeedback(
        candidateId,
        position,
        questionsData
      ) {
        try {
          const response = await fetch(
            `/api/get-feedback/${candidateId}/${position}`
          );
          if (!response.ok) {
            throw new Error("Failed to fetch existing feedback.");
          }
          const feedbackData = await response.json();

          if (feedbackData.message === "No feedback found for this candidate") {
            return; // No existing feedback to populate
          }

          // Populate the skills table with existing responses
          feedbackData.responses.forEach((response) => {
            const questionId = response.questionId;
            document.getElementById(`deployment-${questionId}`).value =
              response.deploymentRating;
          
            document.getElementById(`justification-${questionId}`).value =
              response.justification;
            document.getElementById(`improvements-${questionId}`).value =
              response.improvements;
          });

          // Populate overall feedback and result
          document.getElementById("detailed-feedback").value =
            feedbackData.overall_feedback || "";
          document.getElementById("result").value = feedbackData.result || "";

          showToast("Existing feedback loaded successfully.", "success");
        } catch (error) {
          console.error("Error loading existing feedback:", error);
          // showToast("Failed to load existing feedback.", "error");
        }
      }

      document
        .getElementById("generate-summary")
        .addEventListener("click", function (e) {
          e.preventDefault();
          generateFeedback();
        });

      function populateFeedbackForm(questions) {
        const tbody = document.getElementById("skills-table-body");
        tbody.innerHTML = "";

        questions.forEach((question) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${question.skill_category}</td>
          <td>${question.skill_description}</td>
          <td>${question.is_top_skill ? "Yes" : "No"}</td>
          <td>
              <select id="deployment-${question.id}" required>
                 <option value="Good">Good</option>
                  <option value="Average">Average</option>
                   <option value="Poor">Poor</option>
              </select>
          </td>
          
          <td><textarea id="justification-${
            question.id
          }" required></textarea></td>
          <td><textarea id="improvements-${
            question.id
          }" required></textarea></td>
      `;
          tbody.appendChild(row);
        });
      }

      async function generateFeedback() {
        const geminiApiKey = "AIzaSyD1NqvfelSR6l-8FEIIFiZM3aJmbo2mw-Q";

        // Show loading message
        document.getElementById("loading-message").style.display = "block";

        const responses = Array.from(
          document.querySelectorAll("#skills-table-body tr")
        ).map((row) => {
          const questionId = row.querySelector("select").id.split("-")[1];
          return {
            skillCategory: row.cells[0].textContent,
            skillDescription: row.cells[1].textContent,
            isTopSkill: row.cells[2].textContent === "Yes",
            deployment: row.querySelector(`#deployment-${questionId}`).value,
         
            justification: row.querySelector(`#justification-${questionId}`)
              .value,
            improvements: row.querySelector(`#improvements-${questionId}`)
              .value,
          };
        });

        const payload = {
          contents: [
            {
                   parts: [
                {
                  text: `Based on the candidate's performance across the provided skill categories, generate a concise and professional summary (approximately 120 words) that highlights:

- Key strengths and demonstrated skills
- Notable weaknesses or gaps
- Suggestions for improvement and growth

Please analyze the following data:

${responses
  .map(
    (response) => `
Skill Category: ${response.skillCategory}
- Deployment: ${response.deployment}

- Justification: ${response.justification}
- Suggested Improvements: ${response.improvements}
`
  )
  .join("\n")}

After the summary, provide:

1. A clear recommendation in a new line as:
**Recommendation:** Selected / Rejected

2. A one-line analysis for each skill category, summarizing the candidate’s strengths and weaknesses.

3. A short list of recommended training areas tailored to the candidate’s improvement needs (maximum 3 suggestions).`,
                },
              ],
            },
          ],
        };

        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          const responseBody = await response.json();
          console.log("API Response Body:", responseBody);

          document.getElementById("loading-message").style.display = "none";

          if (
            !response.ok ||
            !responseBody.candidates ||
            responseBody.candidates.length === 0
          ) {
            console.error("Error: Invalid response structure", responseBody);
            alert("Error generating feedback. Please try again later.");
            return;
          }

          const generatedFeedback =
            responseBody.candidates[0]?.content?.parts[0]?.text ||
            "No feedback generated";
          document.getElementById("detailed-feedback").value =
            generatedFeedback;
        } catch (error) {
          console.error("Error generating feedback:", error);
          alert("Error generating feedback. Please try again later.");
          document.getElementById("loading-message").style.display = "none";
        }
      }

      // Function to convert Blob to Base64
      async function convertBlobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(blob);
          reader.onloadend = () => {
            resolve(reader.result.split(",")[1]); // Extract Base64 data
          };
          reader.onerror = reject;
        });
      }

      // Modified submit button event handler with email functionality
      document
        .getElementById("submit-button")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          // Validate required fields
          const detailedFeedback =
            document.getElementById("detailed-feedback").value;
          const result = document.getElementById("result").value;

          if (!detailedFeedback || !result) {
            showToast("Please fill all required fields", "error");
            return;
          }
          // Validate justification and improvements fields
    // const rows = document.querySelectorAll("#skills-table-body tr");
    //       rows.forEach((row, index) => {
    //         const justificationField = row.querySelector(
    //           "textarea[id^='justification']"
    //         );
    //         const improvementsField = row.querySelector(
    //           "textarea[id^='improvements']"
    //         );

    //         const justification = justificationField.value.trim();
    //         const improvements = improvementsField.value.trim();

    //         if (justification.split(/\s+/).length < 25) {
    //           showToast(
    //             `Row ${
    //               index + 1
    //             }: The 'Justification' field must have at least 25 words.`,
    //             "error"
    //           );
    //           justificationField.focus(); // Optionally focus the problematic field
    //           throw new Error(
    //             `Validation failed on Row ${index + 1} (Justification)`
    //           );
    //         }

    //         if (improvements.split(/\s+/).length < 25) {
    //           showToast(
    //             `Row ${
    //               index + 1
    //             }: The 'Improvements' field must have at least 25 words.`,
    //             "error"
    //           );
    //           improvementsField.focus(); // Optionally focus the problematic field
    //           throw new Error(
    //             `Validation failed on Row ${index + 1} (Improvements)`
    //           );
    //         }
    //       });
          const candidateEmail =
            document.getElementById("candidate-email").textContent;
          const candidateName = document.getElementById("candidate-name").value;
          const hrEmail = document.getElementById("hr-email").value;
          const position = document.getElementById("position").value;

          const responses = Array.from(
            document.querySelectorAll("#skills-table-body tr")
          ).map((row) => {
            const questionId = row.querySelector("select").id.split("-")[1];
            return {
              questionId,
              deploymentRating: row.querySelector(`#deployment-${questionId}`)
                .value,
           
              justification: row.querySelector(`#justification-${questionId}`)
                .value,
              improvements: row.querySelector(`#improvements-${questionId}`)
                .value,
            };
          });

          try {
            // Step 1: Generate PDF from the form
            const formContainer = document.querySelector(".form-container");
            const originalStyles = {
              marginLeft: formContainer.style.marginLeft,
              marginTop: formContainer.style.marginTop,
            };

            // Reset margins for PDF generation
            formContainer.style.marginLeft = "0";
            formContainer.style.marginTop = "0";

            // Create a clone for PDF generation with text instead of inputs
            function replaceInputsWithText(container) {
              const clone = container.cloneNode(true);
              clone
                .querySelectorAll("input, textarea, select")
                .forEach((el) => {
                  const wrapper = document.createElement("span");
                  wrapper.textContent = el.value || "N/A";
                  el.parentNode.replaceChild(wrapper, el);
                });
              return clone;
            }

            const clonedForm = replaceInputsWithText(formContainer);

            // Generate PDF using html2pdf
            const pdfBlob = await html2pdf()
              .set({
                margin: 0.5,
                filename: "Interview_Feedback_Form.pdf",
                image: { type: "jpeg", quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true },
                jsPDF: {
                  unit: "in",
                  format: [11, 8.5],
                  orientation: "landscape",
                },
              })
              .from(clonedForm)
              .outputPdf("blob");

            // Restore original styles
            formContainer.style.marginLeft = originalStyles.marginLeft;
            formContainer.style.marginTop = originalStyles.marginTop;

            // Convert PDF to Base64
            const base64PDF = await convertBlobToBase64(pdfBlob);

            // Step 2: Get Microsoft Graph API token
            const tokenRequest = {
              scopes: ["Mail.Send"],
              account: msalInstance.getAllAccounts()[0],
            };

            let tokenResponse;
            try {
              tokenResponse = await msalInstance.acquireTokenSilent(
                tokenRequest
              );
            } catch (silentError) {
              console.warn(
                "Silent token acquisition failed; trying popup.",
                silentError
              );
              tokenResponse = await msalInstance.acquireTokenPopup(
                tokenRequest
              );
            }

            const accessToken = tokenResponse.accessToken;

            // Step 3: Prepare and send email with attachment
            const emailContent = {
              message: {
                subject: `Interview Feedback for ${candidateName} - ${position}`,
                body: {
                  contentType: "HTML",
                  content: `
            <p>Please find the attached interview feedback form for <strong>${candidateName}</strong> for the position of <strong>${position}</strong>.</p>
            <p>Interview Result: <strong>${result}</strong></p>
            <p>Feedback Summary:</p>
            <p>${detailedFeedback.substring(0, 200)}...</p>
          `,
                },
                toRecipients: [{ emailAddress: { address: hrEmail } }],
                attachments: [
                  {
                    "@odata.type": "#microsoft.graph.fileAttachment",
                    name: `Interview_Feedback_${candidateName}.pdf`,
                    contentType: "application/pdf",
                    contentBytes: base64PDF,
                  },
                ],
              },
            };

            // Send email via Microsoft Graph API
            const emailResponse = await fetch(
              "https://graph.microsoft.com/v1.0/me/sendMail",
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(emailContent),
              }
            );

            if (!emailResponse.ok) {
              const emailError = await emailResponse.json();
              console.error("Email sending error:", emailError);
              throw new Error("Failed to send email");
            }

            // Step 4: Submit feedback to the API
            const urlParams = new URLSearchParams(window.location.search);
            const urlPosition = urlParams.get("position") || position;

            // Position-to-API mapping for submission
            const positionToSubmitApi = {
              "Junior .Net Cloud Native Application Engineer - Backend":
                "/api/dotnet_submit-feedback",
              "Senior .Net Cloud Native Application Engineer - Backend":
                "/api/dotnet_submit-feedback",
              "Junior Java Cloud Native Application Engineer - Backend":
                "/api/java_submit-feedback",
              "Senior Java Cloud Native Application Engineer - Backend":
                "/api/java_submit-feedback",
              "Junior Angular Cloud Native Application Engineer - Frontend":
                "/api/angular_submit-feedback",
              "Senior Angular Cloud Native Application Engineer - Frontend":
                "/api/angular_submit-feedback",
              "Junior React Cloud Native Application Engineer - Frontend":
                "/api/react_submit-feedback",
              "Senior React Cloud Native Application Engineer - Frontend":
                "/api/react_submit-feedback",
            };

            // Fallback endpoint if position doesn't match
            const submitApi =
              positionToSubmitApi[urlPosition] ||
              "/api/app_generic_submit-feedback";

            const response = await fetch(submitApi, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                candidateEmail,
                responses,
                detailedFeedback,
                result,
              }),
            });

            const resultData = await response.json();

            if (response.ok) {
              showToast(
                "Feedback submitted and email sent successfully!",
                "success"
              );

              setTimeout(() => {
                if (window.opener) {
                  window.close();
                } else if (window.parent && window.parent.closeFeedbackModal) {
                  window.parent.closeFeedbackModal();
                } else {
                  window.location.href = `L2_App_Technical.html?success=true&candidateEmail=${encodeURIComponent(
                    candidateEmail
                  )}&position=${encodeURIComponent(urlPosition)}`;
                }
              }, 1500);
            } else {
              throw new Error(resultData.error || "Failed to submit feedback");
            }
          } catch (error) {
            console.error("Error in submission process:", error);
            showToast(error.message || "Failed to process submission", "error");
          }
        });
    </script>
  </body>
</html>
